<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档自动分类管理器·纯净无AI版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.12/pdf.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#10b981',
                        cyber: '#00f0ff',
                        dark: '#1a1a2e',
                        darker: '#10101b',
                        light: '#e5e7eb'
                    },
                    fontFamily: {
                        sans: ['Inter','system-ui']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .file-card { @apply bg-darker rounded-lg p-3 border border-gray-800 transition-all duration-200 hover:shadow-md hover:scale-[1.01] hover:border-primary; }
            .btn-glow { @apply transition-shadow hover:shadow-[0_0_8px_rgba(99,102,241,0.3)]; }
            .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #6366f1 #10101b; }
            .scrollbar-thin::-webkit-scrollbar { width: 5px; height: 5px; }
            .scrollbar-thin::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 3px; }
            .scrollbar-thin::-webkit-scrollbar-track { background: #10101b; }
            .music-item { @apply flex items-center justify-between py-1.5 px-2 rounded hover:bg-dark/50 text-sm transition-all; }
            .music-active { @apply bg-primary/20 border-l-2 border-cyber; }
        }
        * { scroll-behavior: auto !important; }
    </style>
</head>
<body class="bg-dark text-light min-h-screen flex flex-col scrollbar-thin">
<!-- 预览弹窗 -->
<div id="previewModal" class="fixed inset-0 z-50 bg-black/85 flex items-center justify-center hidden">
    <div class="bg-darker rounded-lg w-full max-w-4xl max-h-[85vh] overflow-auto p-4 relative">
        <button onclick="closePreview()" class="absolute top-2 right-2 text-xl hover:text-red-400 z-10"><i class="fa-solid fa-xmark"></i></button>
        <div id="previewContent" class="mt-3"></div>
    </div>
</div>

<!-- 音乐列表抽屉 -->
<div id="musicPanel" class="fixed right-0 top-0 bottom-0 w-64 bg-darker border-l border-gray-700 z-40 transform translate-x-full transition-transform duration-300 overflow-y-auto scrollbar-thin">
    <div class="p-3 border-b border-gray-700 sticky top-0 bg-darker">
        <div class="flex items-center justify-between">
            <h3 class="font-bold text-sm">BGM播放列表</h3>
            <button onclick="toggleMusicPanel()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>
    <div id="musicList" class="p-2 space-y-1"></div>
</div>
<div id="mask" class="fixed inset-0 bg-black/40 z-30 hidden" onclick="toggleMusicPanel()"></div>

<!-- 顶部导航 -->
<header class="sticky top-0 z-20 bg-darker px-3 py-2 flex flex-wrap items-center justify-between gap-2 shadow-sm">
    <div class="flex items-center gap-2">
        <i class="fa-solid fa-folder-open text-primary text-xl"></i>
        <h1 class="text-lg font-bold">文档管理器</h1>
    </div>
    <!-- 音乐控制 -->
    <div class="flex items-center gap-2">
        <input type="file" id="bgMusicUpload" accept="audio/*" multiple class="hidden">
        <button onclick="document.getElementById('bgMusicUpload').click()" class="px-2 py-1 bg-primary rounded btn-glow text-xs">
            <i class="fa-solid fa-music mr-1"></i>传BGM
        </button>
        <button onclick="toggleMusicPanel()" class="px-2 py-1 bg-cyber text-dark rounded btn-glow text-xs">
            <i class="fa-solid fa-list mr-1"></i>列表
        </button>
        <div class="flex items-center gap-1">
            <button id="musicPrevBtn" disabled class="p-1.5 hover:text-primary text-sm"><i class="fa-solid fa-backward"></i></button>
            <button id="musicCtrlBtn" disabled class="p-1.5 hover:text-primary text-sm"><i class="fa-solid fa-play"></i></button>
            <button id="musicNextBtn" disabled class="p-1.5 hover:text-primary text-sm"><i class="fa-solid fa-forward"></i></button>
            <button id="loopBtn" class="p-1.5 hover:text-cyber text-sm" title="循环模式"><i class="fa-solid fa-repeat"></i></button>
            <input type="range" id="musicVolume" min="0" max="100" value="70" class="w-16 h-1 bg-gray-700 rounded">
        </div>
    </div>
</header>

<main class="flex-1 p-3 max-w-7xl mx-auto w-full">
    <!-- 功能按钮区 -->
    <div class="flex flex-wrap gap-2 mb-3">
        <input type="file" id="fileUpload" multiple class="hidden">
        <button onclick="document.getElementById('fileUpload').click()" class="px-3 py-1.5 bg-primary rounded btn-glow flex items-center gap-1 text-sm">
            <i class="fa-solid fa-upload"></i>选择文件
        </button>
        <button id="selectAllFileBtn" class="px-3 py-1.5 bg-blue-600 rounded btn-glow text-sm">一键全选文档</button>
        <button id="uploadSelectedBtn" disabled class="px-3 py-1.5 bg-secondary rounded btn-glow text-sm">一键上传选中</button>
        
        <button id="selectAllBtn" class="px-3 py-1.5 bg-blue-600 rounded btn-glow text-sm">全选/反选</button>
        <button id="batchDelBtn" disabled class="px-3 py-1.5 bg-red-600 rounded btn-glow text-sm">批量删除</button>
        <button id="batchRestoreBtn" disabled class="px-3 py-1.5 bg-green-600 rounded btn-glow text-sm hidden">批量恢复</button>
        <button id="batchClearBtn" disabled class="px-3 py-1.5 bg-red-700 rounded btn-glow text-sm hidden">批量永久删</button>
        <button id="switchRecycle" class="px-3 py-1.5 bg-yellow-600 rounded btn-glow text-sm ml-auto sm:ml-0">
            <i class="fa-solid fa-recycle mr-1"></i>回收站
        </button>
    </div>

    <!-- 本地搜索 -->
    <div class="mb-4">
        <div class="flex gap-2">
            <input id="localSearch" placeholder="本地文件名搜索..." class="flex-1 px-2 py-1.5 bg-darker rounded border border-gray-700 outline-none focus:border-primary text-sm">
            <button id="searchLocalBtn" class="px-3 py-1.5 bg-secondary rounded btn-glow text-sm"><i class="fa-solid fa-search"></i></button>
        </div>
    </div>

    <!-- 分类排序 -->
    <div class="flex flex-wrap justify-between items-center mb-3 border-b border-gray-800 pb-1 gap-2">
        <div id="cateTabs" class="flex gap-1.5">
            <button data-cate="all" class="cate-tab active px-2 py-1 rounded text-primary border-b border-primary">全部</button>
            <button data-cate="doc" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">文档</button>
            <button data-cate="img" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">图片</button>
            <button data-cate="video" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">视频</button>
            <button data-cate="compress" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">压缩</button>
            <button data-cate="other" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">其他</button>
        </div>
        <select id="sortSelect" class="bg-darker px-2 py-1 rounded border border-gray-700 outline-none focus:border-primary text-sm">
            <option value="time_new">最新</option>
            <option value="time_old">最早</option>
            <option value="size_big">大小降</option>
            <option value="size_small">大小升</option>
            <option value="name_asc">名称A-Z</option>
        </select>
    </div>

    <!-- 文件网格 -->
    <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 scrollbar-thin max-h-[62vh] overflow-y-auto"></div>
</main>

<footer class="bg-darker py-2 text-center text-gray-400 text-xs">
    <p>流畅静态文档管理器 | 本地存储 &copy; 2026</p>
</footer>

<script>
// ============== 核心配置 ==============
const FILE_KEY = 'doc_files_v2';
const RECYCLE_KEY = 'doc_recycle_v2';
const MUSIC_KEY = 'doc_bgm_v2';

// 全局状态
let fileList = JSON.parse(localStorage.getItem(FILE_KEY)) || [];
let recycleList = JSON.parse(localStorage.getItem(RECYCLE_KEY)) || [];
let bgmList = JSON.parse(localStorage.getItem(MUSIC_KEY)) || [];
let isRecycle = false;
let selectedIds = [];
// 待上传文件缓存
let pendingFiles = [];
// 音乐相关
let currentAudio = null;
let currentTrack = 0;
let loopMode = 'list';
let localSearchKeyword = '';
let currentCate = 'all';
let currentSort = 'time_new';

// 防抖函数
function debounce(func, delay = 120) {
    let timer;
    return (...args) => { clearTimeout(timer); timer = setTimeout(() => func(...args), delay); };
}

// 本地存储节流保存
const saveToLocal = debounce(() => {
    localStorage.setItem(FILE_KEY, JSON.stringify(fileList));
    localStorage.setItem(RECYCLE_KEY, JSON.stringify(recycleList));
    localStorage.setItem(MUSIC_KEY, JSON.stringify(bgmList));
}, 300);

// ============== 文件工具方法 ==============
const getCate = ext => {
    const doc = ['pdf','doc','docx','txt','md','xls','xlsx','ppt','pptx'];
    const img = ['jpg','jpeg','png','gif','bmp','svg','webp'];
    const video = ['mp4','mov','avi','mkv'];
    const zip = ['zip','rar','7z','tar','gz'];
    const e = ext.toLowerCase();
    if(doc.includes(e)) return 'doc';
    if(img.includes(e)) return 'img';
    if(video.includes(e)) return 'video';
    if(zip.includes(e)) return 'compress';
    return 'other';
};
const getIcon = ext => ({doc:'fa-file-lines', img:'fa-file-image', video:'fa-file-video', compress:'fa-file-archive', other:'fa-file'}[getCate(ext)]);
const formatSize = b => b<1024?`${b}B`:b<1024**2?`${(b/1024).toFixed(1)}KB`:`${(b/1024**2).toFixed(1)}MB`;
const uuid = () => Date.now().toString(36);

// ============== 音乐列表面板控制 ==============
const toggleMusicPanel = () => {
    const panel = document.getElementById('musicPanel');
    const mask = document.getElementById('mask');
    panel.classList.toggle('translate-x-full');
    mask.classList.toggle('hidden');
    renderMusicList();
};

// 渲染音乐播放列表
const renderMusicList = () => {
    const container = document.getElementById('musicList');
    if(bgmList.length === 0){
        container.innerHTML = '<p class="text-gray-500 text-center text-xs py-4">暂无BGM，点击上传</p>';
        return;
    }
    let html = '';
    bgmList.forEach((item, index) => {
        const active = index === currentTrack ? 'music-active' : '';
        html += `
        <div class="music-item ${active}">
            <div class="flex items-center gap-2 truncate flex-1" onclick="playMusicByIndex(${index})">
                <i class="fa-solid ${index === currentTrack ? 'fa-volume-high text-cyber' : 'fa-music'} text-xs"></i>
                <span class="truncate text-xs">${item.name}</span>
            </div>
            <button onclick="delMusic(${index})" class="text-gray-400 hover:text-red-400 p-1">
                <i class="fa-solid fa-trash text-xs"></i>
            </button>
        </div>`;
    });
    container.innerHTML = html;
};

// 删除音乐
const delMusic = (index) => {
    if(currentTrack === index){
        if(currentAudio) currentAudio.pause();
        currentAudio = null;
    }
    bgmList.splice(index, 1);
    if(currentTrack > index) currentTrack--;
    saveToLocal();
    renderMusicList();
    updateMusicBtnState();
};

// 指定索引播放音乐
const playMusicByIndex = (index) => {
    currentTrack = index;
    loadTrack(currentTrack);
    currentAudio.play();
    document.getElementById('musicCtrlBtn').innerHTML = '<i class="fa-solid fa-pause"></i>';
    renderMusicList();
};

// ============== 背景音乐完整控制 ==============
const initMusic = () => {
    const u = document.getElementById('bgMusicUpload');
    const prev = document.getElementById('musicPrevBtn');
    const ctrl = document.getElementById('musicCtrlBtn');
    const next = document.getElementById('musicNextBtn');
    const loop = document.getElementById('loopBtn');
    const vol = document.getElementById('musicVolume');

    const updateMusicBtnState = () => {
        const dis = bgmList.length === 0;
        prev.disabled = dis; ctrl.disabled = dis; next.disabled = dis;
    };

    u.onchange = (e) => {
        Array.from(e.target.files).forEach(f => {
            const url = URL.createObjectURL(f);
            bgmList.push({id:uuid(), name:f.name, url:url});
        });
        saveToLocal();
        updateMusicBtnState();
        renderMusicList();
    };

    const loadTrack = (index) => {
        if(!bgmList.length) return;
        currentTrack = Math.max(0, Math.min(index, bgmList.length-1));
        if(currentAudio) { currentAudio.pause(); currentAudio = null; }
        const t = bgmList[currentTrack];
        currentAudio = new Audio(t.url);
        currentAudio.volume = vol.value/100;
        currentAudio.onended = () => {
            if(loopMode === 'one') loadTrack(currentTrack);
            else loadTrack((currentTrack+1) % bgmList.length);
            renderMusicList();
        };
        ctrl.innerHTML = '<i class="fa-solid fa-play"></i>';
        renderMusicList();
    };

    const togglePlay = () => {
        if(!currentAudio) { loadTrack(currentTrack); currentAudio.play(); ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>'; return; }
        currentAudio.paused ? (currentAudio.play(), ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>')
                            : (currentAudio.pause(), ctrl.innerHTML = '<i class="fa-solid fa-play"></i>');
    };

    prev.onclick = () => { 
        loadTrack(currentTrack - 1 < 0 ? bgmList.length-1 : currentTrack -1); 
        currentAudio.play(); ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>'; 
    };
    next.onclick = () => { 
        loadTrack((currentTrack+1) % bgmList.length); 
        currentAudio.play(); ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>'; 
    };
    ctrl.onclick = togglePlay;
    vol.oninput = () => { if(currentAudio) currentAudio.volume = vol.value/100; };

    loop.onclick = () => {
        loopMode = loopMode === 'list' ? 'one' : 'list';
        loop.classList.toggle('text-cyber'); loop.classList.toggle('text-gray-400');
    };
    updateMusicBtnState();
};

// ============== 列表筛选与渲染 ==============
const getRenderList = () => {
    let l = [...(isRecycle ? recycleList : fileList)];
    if(currentCate !== 'all') l = l.filter(i => i.cate === currentCate);
    if(localSearchKeyword) l = l.filter(i => i.name.toLowerCase().includes(localSearchKeyword.toLowerCase()));
    const [k, o] = currentSort.split('_');
    if(k==='time') l.sort((a,b)=>o==='new'?b.time-a.time:a.time-b.time);
    if(k==='size') l.sort((a,b)=>o==='big'?b.size-a.size:a.size-b.size);
    if(k==='name') l.sort((a,b)=>o==='asc'?a.name.localeCompare(b.name):b.name.localeCompare(a.name));
    return l;
};

const render = debounce(() => {
    const g = document.getElementById('fileGrid');
    const list = getRenderList();
    if(list.length === 0) { g.innerHTML = `<div class="col-span-full text-center text-gray-400 py-8"><i class="fa-solid fa-folder-closed text-3xl mb-2 block"></i><p>无文件</p></div>`; return; }

    const frag = document.createDocumentFragment();
    list.forEach(item => {
        const d = document.createElement('div'); d.className = 'file-card';
        d.innerHTML = `
            <input type="checkbox" class="file-check absolute top-2 left-2 w-3.5 h-3.5" data-id="${item.id}" ${selectedIds.includes(item.id)?'checked':''}>
            <div class="text-center pt-3">
                <i class="fa-solid ${getIcon(item.ext)} text-2xl text-primary mb-2 block"></i>
                <p class="text-xs truncate font-medium" title="${item.name}">${item.name}</p>
                <p class="text-[10px] text-gray-400">${formatSize(item.size)}</p>
            </div>
            <div class="flex justify-center gap-1 mt-2 flex-wrap">
                ${isRecycle?`
                    <button onclick="restoreOne('${item.id}')" class="px-1.5 py-0.5 bg-green-600 rounded text-[10px] btn-glow">恢复</button>
                    <button onclick="delForever('${item.id}')" class="px-1.5 py-0.5 bg-red-700 rounded text-[10px] btn-glow">删</button>
                `:`
                    <button onclick="previewFile('${item.id}')" class="px-1.5 py-0.5 bg-cyber text-dark rounded text-[10px] btn-glow">预览</button>
                    <a href="${item.url}" download="${item.name}" class="px-1.5 py-0.5 bg-blue-600 rounded text-[10px] btn-glow">下</a>
                    <button onclick="delOne('${item.id}')" class="px-1.5 py-0.5 bg-red-600 rounded text-[10px] btn-glow">删</button>
                `}
            </div>`;
        frag.appendChild(d);
    });
    g.innerHTML = ''; g.appendChild(frag);

    document.querySelectorAll('.file-check').forEach(b => b.onchange = updateSelected);
    updateBatchBtns();
}, 80);

// ============== 选择与批量按钮状态 ==============
const updateSelected = () => {
    selectedIds = Array.from(document.querySelectorAll('.file-check:checked')).map(b=>b.dataset.id);
    updateBatchBtns();
};

const updateBatchBtns = () => {
    const hasSelected = selectedIds.length > 0;
    // 文档操作按钮
    document.getElementById('batchDelBtn').disabled = !hasSelected || isRecycle;
    document.getElementById('batchRestoreBtn').classList.toggle('hidden', !(isRecycle && hasSelected));
    document.getElementById('batchClearBtn').classList.toggle('hidden', !(isRecycle && hasSelected));
    document.getElementById('batchRestoreBtn').disabled = !hasSelected;
    document.getElementById('batchClearBtn').disabled = !hasSelected;
    // 一键上传按钮
    document.getElementById('uploadSelectedBtn').disabled = pendingFiles.length === 0;
};

// 页面全选/反选
document.getElementById('selectAllBtn').onclick = () => {
    const ids = getRenderList().map(i=>i.id);
    selectedIds = selectedIds.length === ids.length ? [] : ids;
    render();
};

// ============== 新增：文档一键选中上传 ==============
// 缓存待上传文件
document.getElementById('fileUpload').onchange = (e) => {
    pendingFiles = Array.from(e.target.files);
    updateBatchBtns();
    alert(`已选中 ${pendingFiles.length} 个文件，点击「一键上传选中」上传`);
};

// 一键上传选中的本地文件
document.getElementById('uploadSelectedBtn').onclick = () => {
    if(pendingFiles.length === 0){
        alert('暂无选中的待上传文件');
        return;
    }
    if(isRecycle){
        alert('回收站模式无法上传');
        return;
    }
    handleFiles(pendingFiles);
    pendingFiles = [];
    updateBatchBtns();
    alert('上传完成！');
};

// 一键全选当前分类文档
document.getElementById('selectAllFileBtn').onclick = () => {
    const allIds = getRenderList().map(item => item.id);
    selectedIds = allIds;
    render();
};

// ============== 删除/恢复/永久删除 ==============
// 单文件删除
const delOne = (id) => {
    const idx = fileList.findIndex(i=>i.id===id);
    if(idx !== -1) {
        recycleList.unshift(fileList[idx]);
        fileList.splice(idx, 1);
        saveToLocal(); render();
    }
};
// 批量删除
const batchDel = () => {
    if(selectedIds.length === 0) return;
    const toRecycle = fileList.filter(item => selectedIds.includes(item.id));
    fileList = fileList.filter(item => !selectedIds.includes(item.id));
    recycleList.unshift(...toRecycle);
    selectedIds = [];
    saveToLocal(); render();
};

// 单文件恢复
const restoreOne = (id) => {
    const idx = recycleList.findIndex(i=>i.id===id);
    if(idx !== -1) {
        fileList.unshift(recycleList[idx]);
        recycleList.splice(idx, 1);
        saveToLocal(); render();
    }
};
// 批量恢复
const batchRestore = () => {
    if(selectedIds.length === 0) return;
    const restoreItems = recycleList.filter(item => selectedIds.includes(item.id));
    recycleList = recycleList.filter(item => !selectedIds.includes(item.id));
    fileList.unshift(...restoreItems);
    selectedIds = [];
    saveToLocal(); render();
};

// 单文件永久删除
const delForever = (id) => {
    if(confirm('确认永久删除？不可恢复！')){
        recycleList = recycleList.filter(i=>i.id!==id);
        saveToLocal(); render();
    }
};
// 批量永久删除
const batchClear = () => {
    if(selectedIds.length === 0) return;
    if(confirm('确认批量永久删除？所有选中文件将无法恢复！')){
        recycleList = recycleList.filter(item => !selectedIds.includes(item.id));
        selectedIds = [];
        saveToLocal(); render();
    }
};

// 绑定批量按钮事件
document.getElementById('batchDelBtn').onclick = batchDel;
document.getElementById('batchRestoreBtn').onclick = batchRestore;
document.getElementById('batchClearBtn').onclick = batchClear;

// ============== 回收站/分类/排序切换 ==============
document.getElementById('switchRecycle').onclick = () => {
    isRecycle = !isRecycle; selectedIds = [];
    document.getElementById('switchRecycle').innerHTML = isRecycle?'<i class="fa-solid fa-home mr-1"></i>文件库':'<i class="fa-solid fa-recycle mr-1"></i>回收站';
    document.querySelectorAll('.cate-tab').forEach(t=>t.classList.remove('active','text-primary','border-b','border-primary'));
    document.querySelector('[data-cate="all"]').classList.add('active','text-primary','border-b','border-primary');
    currentCate = 'all'; render();
};

document.querySelectorAll('.cate-tab').forEach(t=>{
    t.onclick = () => {
        document.querySelectorAll('.cate-tab').forEach(x=>x.classList.remove('active','text-primary','border-b','border-primary'));
        t.classList.add('active','text-primary','border-b','border-primary');
        currentCate = t.dataset.cate; render();
    };
});

document.getElementById('sortSelect').onchange = (e) => { currentSort = e.target.value; render(); };

// ============== 本地搜索 ==============
const doLocal = debounce(() => {
    localSearchKeyword = document.getElementById('localSearch').value.trim();
    render();
}, 150);
document.getElementById('searchLocalBtn').onclick = doLocal;
document.getElementById('localSearch').oninput = doLocal;

// ============== 文件预览 ==============
function previewFile(id) {
    const f = fileList.find(i=>i.id===id); if(!f) return;
    const m = document.getElementById('previewModal');
    const c = document.getElementById('previewContent');
    c.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';
    m.classList.remove('hidden');

    const e = f.ext.toLowerCase();
    if(['jpg','jpeg','png','gif','webp'].includes(e)) {
        c.innerHTML = `<img src="${f.url}" class="max-w-full max-h-[70vh] mx-auto rounded">`;
    } else if(e === 'pdf') {
        c.innerHTML = '<div id="pdf" class="w-full"></div>';
        pdfjsLib.getDocument(f.url).promise.then(p=>p.getPage(1).then(pg=>{
            const cv = document.createElement('canvas');
            const vp = pg.getViewport({scale:1.2});
            cv.width = vp.width; cv.height = vp.height;
            pg.render({canvasContext:cv.getContext('2d'), viewport:vp});
            document.getElementById('pdf').appendChild(cv);
        }));
    } else if(['txt','md'].includes(e)) {
        fetch(f.url).then(r=>r.text()).then(t=>{c.innerHTML=`<pre class="p-3 bg-dark rounded max-h-[60vh] overflow-auto text-xs">${t}</pre>`;});
    } else if(['mp4','mov'].includes(e)) {
        c.innerHTML = `<video src="${f.url}" controls class="max-w-full mx-auto rounded max-h-[70vh]"></video>`;
    } else {
        c.innerHTML = '<p class="text-center py-6">不支持预览</p>';
    }
}

function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
    document.getElementById('previewContent').innerHTML = '';
}

// ============== 上传/拖拽/粘贴 ==============
const handleFiles = (files) => {
    if(isRecycle) return;
    Array.from(files).forEach(f=>{
        fileList.unshift({
            id:uuid(), name:f.name, ext:f.name.split('.').pop()||'',
            size:f.size, cate:getCate(f.name.split('.').pop()||''),
            url:URL.createObjectURL(f), time:Date.now()
        });
    });
    saveToLocal(); render();
};

document.body.ondragover = (e) => e.preventDefault();
document.body.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
document.onpaste = (e) => {
    const fs = e.clipboardData?.files;
    if(fs?.length) handleFiles(fs);
};

// ============== 页面初始化 ==============
window.onload = () => {
    initMusic();
    render();
    renderMusicList();
    updateBatchBtns();
};
</script>
</body>
</html>