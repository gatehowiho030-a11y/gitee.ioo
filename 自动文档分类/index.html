<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ¡£è‡ªåŠ¨åˆ†ç±»ç®¡ç†å™¨.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.12/pdf.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#10b981',
                        cyber: '#00f0ff',
                        dark: '#1a1a2e',
                        darker: '#10101b',
                        light: '#e5e7eb'
                    },
                    fontFamily: {
                        sans: ['Inter','system-ui']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .file-card { @apply bg-darker rounded-lg p-3 border border-gray-800 transition-all duration-200 hover:shadow-md hover:scale-[1.01] hover:border-primary; }
            .btn-glow { @apply transition-shadow hover:shadow-[0_0_8px_rgba(99,102,241,0.3)]; }
            .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #6366f1 #10101b; }
            .scrollbar-thin::-webkit-scrollbar { width: 5px; height: 5px; }
            .scrollbar-thin::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 3px; }
            .scrollbar-thin::-webkit-scrollbar-track { background: #10101b; }
        }
        * { scroll-behavior: auto !important; }
    </style>
</head>
<body class="bg-dark text-light min-h-screen flex flex-col scrollbar-thin">
<!-- é¢„è§ˆå¼¹çª— -->
<div id="previewModal" class="fixed inset-0 z-50 bg-black/85 flex items-center justify-center hidden">
    <div class="bg-darker rounded-lg w-full max-w-4xl max-h-[85vh] overflow-auto p-4 relative">
        <button onclick="closePreview()" class="absolute top-2 right-2 text-xl hover:text-red-400 z-10"><i class="fa-solid fa-xmark"></i></button>
        <div id="previewContent" class="mt-3"></div>
    </div>
</div>

<!-- é¡¶éƒ¨å¯¼èˆª -->
<header class="sticky top-0 z-40 bg-darker px-3 py-2 flex flex-wrap items-center justify-between gap-2 shadow-sm">
    <div class="flex items-center gap-2">
        <i class="fa-solid fa-folder-open text-primary text-xl"></i>
        <h1 class="text-lg font-bold">æ–‡æ¡£ç®¡ç†å™¨</h1>
    </div>
    <!-- éŸ³ä¹æ§åˆ¶ -->
    <div class="flex items-center gap-2">
        <input type="file" id="bgMusicUpload" accept="audio/*" multiple class="hidden">
        <button onclick="document.getElementById('bgMusicUpload').click()" class="px-2 py-1 bg-primary rounded btn-glow text-xs">
            <i class="fa-solid fa-music mr-1"></i>ä¼ BGM
        </button>
        <div class="flex items-center gap-1">
            <button id="musicPrevBtn" disabled class="p-1.5 hover:text-primary text-sm"><i class="fa-solid fa-backward"></i></button>
            <button id="musicCtrlBtn" disabled class="p-1.5 hover:text-primary text-sm"><i class="fa-solid fa-play"></i></button>
            <button id="musicNextBtn" disabled class="p-1.5 hover:text-primary text-sm"><i class="fa-solid fa-forward"></i></button>
            <button id="loopBtn" class="p-1.5 hover:text-cyber text-sm" title="å¾ªç¯æ¨¡å¼"><i class="fa-solid fa-repeat"></i></button>
            <input type="range" id="musicVolume" min="0" max="100" value="70" class="w-16 h-1 bg-gray-700 rounded">
        </div>
    </div>
</header>

<main class="flex-1 p-3 max-w-7xl mx-auto w-full">
    <!-- åŠŸèƒ½æŒ‰é’®åŒº -->
    <div class="flex flex-wrap gap-2 mb-3">
        <input type="file" id="fileUpload" multiple class="hidden">
        <button onclick="document.getElementById('fileUpload').click()" class="px-3 py-1.5 bg-primary rounded btn-glow flex items-center gap-1 text-sm">
            <i class="fa-solid fa-upload"></i>ä¸Šä¼ 
        </button>
        <button id="selectAllBtn" class="px-3 py-1.5 bg-blue-600 rounded btn-glow text-sm">å…¨é€‰/åé€‰</button>
        <button id="batchDelBtn" disabled class="px-3 py-1.5 bg-red-600 rounded btn-glow text-sm">æ‰¹é‡åˆ é™¤</button>
        <button id="batchRestoreBtn" disabled class="px-3 py-1.5 bg-green-600 rounded btn-glow text-sm hidden">æ‰¹é‡æ¢å¤</button>
        <button id="batchClearBtn" disabled class="px-3 py-1.5 bg-red-700 rounded btn-glow text-sm hidden">æ‰¹é‡æ°¸ä¹…åˆ </button>
        <button id="switchRecycle" class="px-3 py-1.5 bg-yellow-600 rounded btn-glow text-sm ml-auto sm:ml-0">
            <i class="fa-solid fa-recycle mr-1"></i>å›æ”¶ç«™
        </button>
    </div>

    <!-- æœç´¢åŒº -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <div class="flex gap-2">
            <input id="localSearch" placeholder="æœ¬åœ°æ–‡ä»¶åæœç´¢..." class="flex-1 px-2 py-1.5 bg-darker rounded border border-gray-700 outline-none focus:border-primary text-sm">
            <button id="searchLocalBtn" class="px-3 py-1.5 bg-secondary rounded btn-glow text-sm"><i class="fa-solid fa-search"></i></button>
        </div>
        <div class="flex gap-2">
            <input id="aiSearch" placeholder="AIæ™ºèƒ½æœç´¢/é—®ç­”..." class="flex-1 px-2 py-1.5 bg-darker rounded border border-gray-700 outline-none focus:border-primary text-sm">
            <button id="aiSearchBtn" class="px-3 py-1.5 bg-cyber text-dark font-bold rounded btn-glow text-sm">AIæœç´¢</button>
        </div>
    </div>

    <!-- AIç»“æœåŒº -->
    <div id="aiResult" class="mb-4 p-3 bg-darker rounded-lg hidden border border-gray-700 text-sm">
        <div class="flex justify-between mb-2">
            <h3 class="font-semibold text-cyber">AIç»“æœ</h3>
            <button onclick="document.getElementById('aiResult').classList.add('hidden')" class="hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="aiContent" class="whitespace-pre-line"></div>
    </div>

    <!-- åˆ†ç±»æ’åº -->
    <div class="flex flex-wrap justify-between items-center mb-3 border-b border-gray-800 pb-1 gap-2">
        <div id="cateTabs" class="flex gap-1.5">
            <button data-cate="all" class="cate-tab active px-2 py-1 rounded text-primary border-b border-primary">å…¨éƒ¨</button>
            <button data-cate="doc" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">æ–‡æ¡£</button>
            <button data-cate="img" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">å›¾ç‰‡</button>
            <button data-cate="video" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">è§†é¢‘</button>
            <button data-cate="compress" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">å‹ç¼©</button>
            <button data-cate="other" class="cate-tab px-2 py-1 rounded hover:text-primary text-sm">å…¶ä»–</button>
        </div>
        <select id="sortSelect" class="bg-darker px-2 py-1 rounded border border-gray-700 outline-none focus:border-primary text-sm">
            <option value="time_new">æœ€æ–°</option>
            <option value="time_old">æœ€æ—©</option>
            <option value="size_big">å¤§å°é™</option>
            <option value="size_small">å¤§å°å‡</option>
            <option value="name_asc">åç§°A-Z</option>
        </select>
    </div>

    <!-- æ–‡ä»¶ç½‘æ ¼ -->
    <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 scrollbar-thin max-h-[62vh] overflow-y-auto"></div>
</main>

<footer class="bg-darker py-2 text-center text-gray-400 text-xs">
    <p>æµç•…é™æ€æ–‡æ¡£ç®¡ç†å™¨ | æœ¬åœ°å­˜å‚¨ &copy; 2026</p>
</footer>

<script>
// ============== æ ¸å¿ƒé…ç½® ==============
const FILE_KEY = 'doc_files_v2';
const RECYCLE_KEY = 'doc_recycle_v2';
const MUSIC_KEY = 'doc_bgm_v2';
// é€šä¹‰åƒé—®APIé…ç½®
const AI_URL = 'https://bailian.console.aliyun.com/cn-beijing/?spm=a2c4g.11186623.0.0.782270afqlDEXz&tab=model#/efm/model_experience_center/text';
// åœ¨æ­¤å¡«å…¥ä½ è·å–çš„API Key
const AI_KEY = 'sk-50efe641ed0a49ac9f3f5052e721c319';

// å…¨å±€çŠ¶æ€
let fileList = JSON.parse(localStorage.getItem(FILE_KEY)) || [];
let recycleList = JSON.parse(localStorage.getItem(RECYCLE_KEY)) || [];
let bgmList = JSON.parse(localStorage.getItem(MUSIC_KEY)) || [];
let isRecycle = false;
let selectedIds = [];
let currentAudio = null;
let currentTrack = 0;
let loopMode = 'list';
let localSearchKeyword = '';
let currentCate = 'all';
let currentSort = 'time_new';

// é˜²æŠ–å‡½æ•°
function debounce(func, delay = 120) {
    let timer;
    return (...args) => { clearTimeout(timer); timer = setTimeout(() => func(...args), delay); };
}

// æœ¬åœ°å­˜å‚¨èŠ‚æµä¿å­˜
const saveToLocal = debounce(() => {
    localStorage.setItem(FILE_KEY, JSON.stringify(fileList));
    localStorage.setItem(RECYCLE_KEY, JSON.stringify(recycleList));
    localStorage.setItem(MUSIC_KEY, JSON.stringify(bgmList));
}, 300);

// ============== æ–‡ä»¶å·¥å…·æ–¹æ³• ==============
const getCate = ext => {
    const doc = ['pdf','doc','docx','txt','md','xls','xlsx','ppt','pptx'];
    const img = ['jpg','jpeg','png','gif','bmp','svg','webp'];
    const video = ['mp4','mov','avi','mkv'];
    const zip = ['zip','rar','7z','tar','gz'];
    const e = ext.toLowerCase();
    if(doc.includes(e)) return 'doc';
    if(img.includes(e)) return 'img';
    if(video.includes(e)) return 'video';
    if(zip.includes(e)) return 'compress';
    return 'other';
};
const getIcon = ext => ({doc:'fa-file-lines', img:'fa-file-image', video:'fa-file-video', compress:'fa-file-archive', other:'fa-file'}[getCate(ext)]);
const formatSize = b => b<1024?`${b}B`:b<1024**2?`${(b/1024).toFixed(1)}KB`:`${(b/1024**2).toFixed(1)}MB`;
const uuid = () => Date.now().toString(36);

// ============== èƒŒæ™¯éŸ³ä¹å®Œæ•´æ§åˆ¶ ==============
const initMusic = () => {
    const u = document.getElementById('bgMusicUpload');
    const prev = document.getElementById('musicPrevBtn');
    const ctrl = document.getElementById('musicCtrlBtn');
    const next = document.getElementById('musicNextBtn');
    const loop = document.getElementById('loopBtn');
    const vol = document.getElementById('musicVolume');

    const updateBtnState = () => {
        const dis = bgmList.length === 0;
        prev.disabled = dis; ctrl.disabled = dis; next.disabled = dis;
    };

    u.onchange = (e) => {
        Array.from(e.target.files).forEach(f => {
            const url = URL.createObjectURL(f);
            bgmList.push({id:uuid(), name:f.name, url:url});
        });
        saveToLocal(); updateBtnState();
    };

    const loadTrack = (index) => {
        if(!bgmList.length) return;
        currentTrack = Math.max(0, Math.min(index, bgmList.length-1));
        if(currentAudio) { currentAudio.pause(); currentAudio = null; }
        const t = bgmList[currentTrack];
        currentAudio = new Audio(t.url);
        currentAudio.volume = vol.value/100;
        currentAudio.onended = () => {
            if(loopMode === 'one') loadTrack(currentTrack);
            else loadTrack((currentTrack+1) % bgmList.length);
        };
        ctrl.innerHTML = '<i class="fa-solid fa-play"></i>';
    };

    const togglePlay = () => {
        if(!currentAudio) { loadTrack(currentTrack); currentAudio.play(); ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>'; return; }
        currentAudio.paused ? (currentAudio.play(), ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>')
                            : (currentAudio.pause(), ctrl.innerHTML = '<i class="fa-solid fa-play"></i>');
    };

    prev.onclick = () => { loadTrack(currentTrack - 1 < 0 ? bgmList.length-1 : currentTrack -1); currentAudio.play(); ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>'; };
    next.onclick = () => { loadTrack((currentTrack+1) % bgmList.length); currentAudio.play(); ctrl.innerHTML = '<i class="fa-solid fa-pause"></i>'; };
    ctrl.onclick = togglePlay;
    vol.oninput = () => { if(currentAudio) currentAudio.volume = vol.value/100; };

    loop.onclick = () => {
        loopMode = loopMode === 'list' ? 'one' : 'list';
        loop.classList.toggle('text-cyber'); loop.classList.toggle('text-gray-400');
    };
    updateBtnState();
};

// ============== åˆ—è¡¨ç­›é€‰ä¸æ¸²æŸ“ ==============
const getRenderList = () => {
    let l = [...(isRecycle ? recycleList : fileList)];
    if(currentCate !== 'all') l = l.filter(i => i.cate === currentCate);
    if(localSearchKeyword) l = l.filter(i => i.name.toLowerCase().includes(localSearchKeyword.toLowerCase()));
    const [k, o] = currentSort.split('_');
    if(k==='time') l.sort((a,b)=>o==='new'?b.time-a.time:a.time-b.time);
    if(k==='size') l.sort((a,b)=>o==='big'?b.size-a.size:a.size-b.size);
    if(k==='name') l.sort((a,b)=>o==='asc'?a.name.localeCompare(b.name):b.name.localeCompare(a.name));
    return l;
};

const render = debounce(() => {
    const g = document.getElementById('fileGrid');
    const list = getRenderList();
    if(list.length === 0) { g.innerHTML = `<div class="col-span-full text-center text-gray-400 py-8"><i class="fa-solid fa-folder-closed text-3xl mb-2 block"></i><p>æ— æ–‡ä»¶</p></div>`; return; }

    const frag = document.createDocumentFragment();
    list.forEach(item => {
        const d = document.createElement('div'); d.className = 'file-card';
        d.innerHTML = `
            <input type="checkbox" class="file-check absolute top-2 left-2 w-3.5 h-3.5" data-id="${item.id}" ${selectedIds.includes(item.id)?'checked':''}>
            <div class="text-center pt-3">
                <i class="fa-solid ${getIcon(item.ext)} text-2xl text-primary mb-2 block"></i>
                <p class="text-xs truncate font-medium" title="${item.name}">${item.name}</p>
                <p class="text-[10px] text-gray-400">${formatSize(item.size)}</p>
            </div>
            <div class="flex justify-center gap-1 mt-2 flex-wrap">
                ${isRecycle?`
                    <button onclick="restoreOne('${item.id}')" class="px-1.5 py-0.5 bg-green-600 rounded text-[10px] btn-glow">æ¢å¤</button>
                    <button onclick="delForever('${item.id}')" class="px-1.5 py-0.5 bg-red-700 rounded text-[10px] btn-glow">åˆ </button>
                `:`
                    <button onclick="previewFile('${item.id}')" class="px-1.5 py-0.5 bg-cyber text-dark rounded text-[10px] btn-glow">é¢„è§ˆ</button>
                    <a href="${item.url}" download="${item.name}" class="px-1.5 py-0.5 bg-blue-600 rounded text-[10px] btn-glow">ä¸‹</a>
                    <button onclick="delOne('${item.id}')" class="px-1.5 py-0.5 bg-red-600 rounded text-[10px] btn-glow">åˆ </button>
                `}
            </div>`;
        frag.appendChild(d);
    });
    g.innerHTML = ''; g.appendChild(frag);

    document.querySelectorAll('.file-check').forEach(b => b.onchange = updateSelected);
    updateBatchBtns();
}, 80);

// ============== é€‰æ‹©ä¸æ‰¹é‡æŒ‰é’®çŠ¶æ€ ==============
const updateSelected = () => {
    selectedIds = Array.from(document.querySelectorAll('.file-check:checked')).map(b=>b.dataset.id);
    updateBatchBtns();
};

const updateBatchBtns = () => {
    const hasSelected = selectedIds.length > 0;
    document.getElementById('batchDelBtn').disabled = !hasSelected || isRecycle;
    // ä¿®å¤æ‰¹é‡æŒ‰é’®æ˜¾éšé€»è¾‘
    document.getElementById('batchRestoreBtn').classList.toggle('hidden', !(isRecycle && hasSelected));
    document.getElementById('batchClearBtn').classList.toggle('hidden', !(isRecycle && hasSelected));
    // æ‰¹é‡æŒ‰é’®ç¦ç”¨çŠ¶æ€åŒæ­¥
    document.getElementById('batchRestoreBtn').disabled = !hasSelected;
    document.getElementById('batchClearBtn').disabled = !hasSelected;
};

document.getElementById('selectAllBtn').onclick = () => {
    const ids = getRenderList().map(i=>i.id);
    selectedIds = selectedIds.length === ids.length ? [] : ids;
    render();
};

// ============== ä¿®å¤ï¼šæ‰¹é‡åˆ é™¤/æ¢å¤/æ°¸ä¹…åˆ é™¤ ==============
// å•æ–‡ä»¶åˆ é™¤
const delOne = (id) => {
    const idx = fileList.findIndex(i=>i.id===id);
    if(idx !== -1) {
        recycleList.unshift(fileList[idx]);
        fileList.splice(idx, 1);
        saveToLocal(); render();
    }
};
// æ‰¹é‡åˆ é™¤
const batchDel = () => {
    if(selectedIds.length === 0) return;
    const toRecycle = fileList.filter(item => selectedIds.includes(item.id));
    fileList = fileList.filter(item => !selectedIds.includes(item.id));
    recycleList.unshift(...toRecycle);
    selectedIds = [];
    saveToLocal(); render();
};

// ä¿®å¤ï¼šå•æ–‡ä»¶æ¢å¤
const restoreOne = (id) => {
    const idx = recycleList.findIndex(i=>i.id===id);
    if(idx !== -1) {
        fileList.unshift(recycleList[idx]);
        recycleList.splice(idx, 1);
        saveToLocal(); render();
    }
};
// ä¿®å¤ï¼šæ‰¹é‡æ¢å¤
const batchRestore = () => {
    if(selectedIds.length === 0) return;
    // ç­›é€‰è¦æ¢å¤çš„æ–‡ä»¶
    const restoreItems = recycleList.filter(item => selectedIds.includes(item.id));
    // ä»å›æ”¶ç«™ç§»é™¤
    recycleList = recycleList.filter(item => !selectedIds.includes(item.id));
    // åŠ å…¥ä¸»æ–‡ä»¶åˆ—è¡¨
    fileList.unshift(...restoreItems);
    // æ¸…ç©ºé€‰æ‹©
    selectedIds = [];
    saveToLocal(); render();
};

// ä¿®å¤ï¼šå•æ–‡ä»¶æ°¸ä¹…åˆ é™¤
const delForever = (id) => {
    if(confirm('ç¡®è®¤æ°¸ä¹…åˆ é™¤ï¼Ÿä¸å¯æ¢å¤ï¼')){
        recycleList = recycleList.filter(i=>i.id!==id);
        saveToLocal(); render();
    }
};
// ä¿®å¤ï¼šæ‰¹é‡æ°¸ä¹…åˆ é™¤
const batchClear = () => {
    if(selectedIds.length === 0) return;
    if(confirm('ç¡®è®¤æ‰¹é‡æ°¸ä¹…åˆ é™¤ï¼Ÿæ‰€æœ‰é€‰ä¸­æ–‡ä»¶å°†æ— æ³•æ¢å¤ï¼')){
        // è¿‡æ»¤æ‰é€‰ä¸­çš„IDï¼Œä¿ç•™æœªé€‰ä¸­çš„
        recycleList = recycleList.filter(item => !selectedIds.includes(item.id));
        selectedIds = [];
        saveToLocal(); render();
    }
};

// ç»‘å®šæ‰¹é‡æŒ‰é’®äº‹ä»¶
document.getElementById('batchDelBtn').onclick = batchDel;
document.getElementById('batchRestoreBtn').onclick = batchRestore;
document.getElementById('batchClearBtn').onclick = batchClear;

// ============== å›æ”¶ç«™/åˆ†ç±»/æ’åºåˆ‡æ¢ ==============
document.getElementById('switchRecycle').onclick = () => {
    isRecycle = !isRecycle; selectedIds = [];
    document.getElementById('switchRecycle').innerHTML = isRecycle?'<i class="fa-solid fa-home mr-1"></i>æ–‡ä»¶åº“':'<i class="fa-solid fa-recycle mr-1"></i>å›æ”¶ç«™';
    document.querySelectorAll('.cate-tab').forEach(t=>t.classList.remove('active','text-primary','border-b','border-primary'));
    document.querySelector('[data-cate="all"]').classList.add('active','text-primary','border-b','border-primary');
    currentCate = 'all'; render();
};

document.querySelectorAll('.cate-tab').forEach(t=>{
    t.onclick = () => {
        document.querySelectorAll('.cate-tab').forEach(x=>x.classList.remove('active','text-primary','border-b','border-primary'));
        t.classList.add('active','text-primary','border-b','border-primary');
        currentCate = t.dataset.cate; render();
    };
});

document.getElementById('sortSelect').onchange = (e) => { currentSort = e.target.value; render(); };

// ============== æœ¬åœ°æœç´¢ ==============
const doLocal = debounce(() => {
    localSearchKeyword = document.getElementById('localSearch').value.trim();
    render();
}, 150);
document.getElementById('searchLocalBtn').onclick = doLocal;
document.getElementById('localSearch').oninput = doLocal;

// ============== æ–‡ä»¶é¢„è§ˆ ==============
function previewFile(id) {
    const f = fileList.find(i=>i.id===id); if(!f) return;
    const m = document.getElementById('previewModal');
    const c = document.getElementById('previewContent');
    c.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';
    m.classList.remove('hidden');

    const e = f.ext.toLowerCase();
    if(['jpg','jpeg','png','gif','webp'].includes(e)) {
        c.innerHTML = `<img src="${f.url}" class="max-w-full max-h-[70vh] mx-auto rounded">`;
    } else if(e === 'pdf') {
        c.innerHTML = '<div id="pdf" class="w-full"></div>';
        pdfjsLib.getDocument(f.url).promise.then(p=>p.getPage(1).then(pg=>{
            const cv = document.createElement('canvas');
            const vp = pg.getViewport({scale:1.2});
            cv.width = vp.width; cv.height = vp.height;
            pg.render({canvasContext:cv.getContext('2d'), viewport:vp});
            document.getElementById('pdf').appendChild(cv);
        }));
    } else if(['txt','md'].includes(e)) {
        fetch(f.url).then(r=>r.text()).then(t=>{c.innerHTML=`<pre class="p-3 bg-dark rounded max-h-[60vh] overflow-auto text-xs">${t}</pre>`;});
    } else if(['mp4','mov'].includes(e)) {
        c.innerHTML = `<video src="${f.url}" controls class="max-w-full mx-auto rounded max-h-[70vh]"></video>`;
    } else {
        c.innerHTML = '<p class="text-center py-6">ä¸æ”¯æŒé¢„è§ˆ</p>';
    }
}

function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
    document.getElementById('previewContent').innerHTML = '';
}

// ============== AIè°ƒç”¨ï¼ˆé€šä¹‰åƒé—®å®˜æ–¹å…¼å®¹+ç¦»çº¿å…œåº•ï¼‰==============
const offlineAI = (q) => {
    return `ğŸ“ ç¦»çº¿å…œåº•å›å¤
ä½ è¾“å…¥çš„å†…å®¹ï¼š${q}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
APIè°ƒç”¨å¤±è´¥è¯·æ£€æŸ¥ï¼š
1. API Keyæ˜¯å¦æ­£ç¡®å¤åˆ¶å¡«å…¥
2. å·²é¢†å–qwen-turboå…è´¹é¢åº¦
3  ç½‘ç»œæ­£å¸¸æ— ä»£ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è·å–Keyæ•™ç¨‹ï¼šhttps://dashscope.console.aliyun.com/apiKeyManagement`;
};

document.getElementById('aiSearchBtn').onclick = async () => {
    const q = document.getElementById('aiSearch').value.trim();
    if(!q) return alert('è¯·è¾“å…¥AIæœç´¢å†…å®¹');
    const rBox = document.getElementById('aiResult');
    const rContent = document.getElementById('aiContent');
    rBox.classList.remove('hidden');
    rContent.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>AIè°ƒç”¨ä¸­...';

    // æœªå¡«API Keyç›´æ¥èµ°å…œåº•
    if(!AI_KEY || AI_KEY === 'sk-50efe641ed0a49ac9f3f5052e721c319'){
        rContent.innerHTML = 'âŒ æœªé…ç½®API Keyï¼Œè¯·å…ˆè·å–å¹¶å¡«å…¥ä»£ç ä¸­çš„AI_KEYå˜é‡\n'+offlineAI(q);
        return;
    }

    try {
        const resp = await fetch(AI_URL,{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'Authorization':`Bearer ${AI_KEY}`
            },
            body:JSON.stringify({
                "model":"qwen-turbo",
                "input":{
                    "messages":[
                        {"role":"system","content":"ä½ æ˜¯æ–‡æ¡£ç®¡ç†åŠ©æ‰‹ï¼Œç®€æ´å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œæ§åˆ¶å­—æ•°åœ¨300å­—å†…"},
                        {"role":"user","content":q}
                    ]
                },
                "parameters":{"temperature":0.4,"max_tokens":600}
            })
        });

        const data = await resp.json();
        if(data?.output?.text){
            rContent.innerHTML = data.output.text;
        } else {
            throw new Error(data?.message || 'æ— è¿”å›å†…å®¹');
        }
    } catch (err) {
        rContent.innerHTML = `âŒ AIè°ƒç”¨å¤±è´¥ï¼š${err.message}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n${offlineAI(q)}`;
    }
};

// ============== ä¸Šä¼ /æ‹–æ‹½/ç²˜è´´ ==============
const handleFiles = (files) => {
    if(isRecycle) return;
    Array.from(files).forEach(f=>{
        fileList.unshift({
            id:uuid(), name:f.name, ext:f.name.split('.').pop()||'',
            size:f.size, cate:getCate(f.name.split('.').pop()||''),
            url:URL.createObjectURL(f), time:Date.now()
        });
    });
    saveToLocal(); render();
};

document.getElementById('fileUpload').onchange = (e) => handleFiles(e.target.files);
document.body.ondragover = (e) => e.preventDefault();
document.body.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
document.onpaste = (e) => {
    const fs = e.clipboardData?.files;
    if(fs?.length) handleFiles(fs);
};

// ============== é¡µé¢åˆå§‹åŒ– ==============
window.onload = () => {
    initMusic();
    render();
};
</script>
</body>
</html>